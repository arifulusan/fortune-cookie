<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fortune Cookie — Delight</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
  <style>
/* Language switch */
.lang-switch{
  position:fixed; top:14px; right:14px; display:flex; gap:8px;
  background:rgba(255,255,255,.9); border:1px solid rgba(0,0,0,.06);
  padding:6px; border-radius:999px; box-shadow: var(--shadow);
}
.lang-switch button{
  border:0; background:transparent; padding:6px 10px; border-radius:999px;
  font-weight:700; cursor:pointer
}
.lang-switch button.active{ background:#111827; color:#fff }

:root{
  --ink:#0e0f13; --muted:#6b7280; --card: rgba(255,255,255,.75);
  --pill:#eef2ff; --accent:#f59e0b; --shadow: 0 12px 30px rgba(0,0,0,.10), 0 2px 8px rgba(0,0,0,.06);
  --radius:22px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink); font:16px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  display:grid; place-items:center; overflow:hidden;
  background: radial-gradient(1200px 800px at 20% 10%, #fff7ed 0%, #ffedd5 30%, #f1f5f9 70%),
              linear-gradient(120deg,#fef3c7 0%, #e0e7ff 50%, #fdf2f8 100%);
}
.wrap{ width:min(760px, 92vw); text-align:center; position:relative; }

h1{ font-size:clamp(1.4rem,1rem+2.2vw,2.2rem); margin: 0 0 .25rem; font-weight:800; letter-spacing:.2px }
p.sub{ color:var(--muted); margin:.25rem 0 1.2rem }
.intro.hide{ animation: fadeOut .28s ease forwards; }
@keyframes fadeOut{ to{ opacity:0; transform: translateY(-6px) scale(.98);} }

.stage{ display:grid; place-items:center; min-height:320px; position:relative; }

.cookie-btn{ border:0; background:transparent; cursor:pointer; padding:0; -webkit-tap-highlight-color:transparent; }
.cookie{ width:220px; height:220px; filter: drop-shadow(0 14px 24px rgba(0,0,0,.12)); transition: transform .18s ease; }
.cookie-btn:hover .cookie{ transform: translateY(-3px) rotate(-1deg) scale(1.02); }
.cookie-btn:active .cookie{ transform: translateY(0) scale(.98); }
.crack-left{ transform-origin: 60% 60%; }
.crack-right{ transform-origin: 40% 60%; }
.open .crack-left{ animation: leftBreak .6s cubic-bezier(.2,.7,.2,1) forwards; }
.open .crack-right{ animation: rightBreak .6s cubic-bezier(.2,.7,.2,1) forwards; }
@keyframes leftBreak{ to{ transform: translate(-28px, -16px) rotate(-18deg); opacity:.96; } }
@keyframes rightBreak{ to{ transform: translate(28px, 16px) rotate(18deg); opacity:.96; } }
.cookie-btn.hide{ animation: cookieFade .28s ease forwards; pointer-events:none; }
@keyframes cookieFade{ to{ opacity:0; transform: translateY(-6px) scale(.98);} }

.card{
  margin: 8px auto 0; backdrop-filter: blur(10px); background:var(--card); border:1px solid rgba(255,255,255,.6);
  border-radius: var(--radius); box-shadow: var(--shadow); padding: 22px 24px; max-width: 620px; opacity:0; transform: translateY(8px) scale(1); display:none;
}
.card.show{ display:block; animation: popIn .42s cubic-bezier(.2,.8,.2,1) forwards; }
@keyframes popIn{ to{ opacity:1; transform: translateY(0) scale(1);} }
.fortune{ font-size: clamp(1.15rem, 1rem + .9vw, 1.6rem); font-weight:600; letter-spacing:.2px; }
.meta{ display:flex; gap:10px; align-items:center; justify-content:center; margin-top:12px; color:var(--muted); font-size:.9rem; flex-wrap:wrap }
.pill{ background:var(--pill); color:#1f2937; padding:6px 12px; border-radius:999px; font-size:.8rem; border:1px solid rgba(99,102,241,.15) }
.actions{ display:flex; gap:10px; justify-content:center; margin-top:14px; flex-wrap:wrap }
.btn{ border:0; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700; letter-spacing:.2px }
.btn.copy{ background:#111827; color:#fff }
.btn.share{ background:#fde68a; color:#7c2d12 }
.note{ color:var(--muted); margin-top:10px; font-size:.85rem }

canvas#confetti{
  position:absolute; inset:0; width:100%; height:100%; pointer-events:none;
  display:none;
}

@media (prefers-reduced-motion: reduce){
  .open .crack-left,.open .crack-right{ animation:none; }
  .card.show{ animation:none; opacity:1; transform:none }
}
  </style>
</head>
<body>
  <div class="lang-switch" role="group" aria-label="Language switcher">
    <button id="langEN" class="active" data-lang="en" aria-pressed="true">EN</button>
    <button id="langTR" data-lang="tr" aria-pressed="false">TR</button>
  </div>

  <main class="wrap">
    <h1 class="intro" id="title">Tap the cookie for your fortune</h1>
    <p class="sub intro" id="subtitle">Click to crack the cookie and reveal your fortune.</p>

    <div class="stage">
      <canvas id="confetti" aria-hidden="true"></canvas>

      <button class="cookie-btn" id="cookieBtn" aria-label="Open fortune cookie" title="Open fortune cookie">
        <svg class="cookie" viewBox="0 0 200 200" role="img" aria-hidden="true">
          <defs>
            <linearGradient id="cookieGrad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#fbbf24"/>
              <stop offset="100%" stop-color="#d97706"/>
            </linearGradient>
            <filter id="soft" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="6" stdDeviation="8" flood-color="#000" flood-opacity=".16"/>
            </filter>
          </defs>
          <ellipse cx="100" cy="148" rx="52" ry="14" fill="#000" opacity=".10"/>
          <path class="crack-left" filter="url(#soft)"
            d="M110 63c-9-8-27-13-45-3-27 14-32 51-15 74 13 18 37 23 55 14 9-5 14-11 16-19 3-12-1-26-4-36-3-9-4-19-7-30z"
            fill="url(#cookieGrad)"/>
          <path class="crack-right" filter="url(#soft)"
            d="M92 63c9-8 27-13 45-3 27 14 32 51 15 74-13 18-37 23-55 14-9-5-14-11-16-19-3-12 1-26 4-36 3-9 4-19 7-30z"
            fill="url(#cookieGrad)"/>
          <rect x="82" y="95" width="36" height="10" rx="2" fill="#fff"/>
        </svg>
      </button>

      <section class="card" id="card" aria-live="polite">
        <div class="fortune" id="fortuneText"></div>
        <div class="meta">
          <span class="pill" id="datePill"></span>
          <span class="pill" id="countdown">24:00:00</span>
        </div>
        <div class="actions">
          <button class="btn copy" id="copyBtn">Copy</button>
          <button class="btn share" id="shareBtn" hidden>Share</button>
        </div>
        <div class="note" id="note"></div>
      </section>
    </div>
  </main>

  <script>
    // ===== DOM elements FIRST =====
    const btn = document.getElementById('cookieBtn');
    const card = document.getElementById('card');
    const fortuneText = document.getElementById('fortuneText');
    const datePill = document.getElementById('datePill');
    const note = document.getElementById('note');
    const copyBtn = document.getElementById('copyBtn');
    const shareBtn = document.getElementById('shareBtn');
    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const countdownEl = document.getElementById('countdown');
    const confetti = document.getElementById('confetti');

    // ===== Language switch =====
    const langEN = document.getElementById('langEN');
    const langTR = document.getElementById('langTR');

    const i18n = {
      en: {
        title: 'Tap the cookie for your fortune',
        subtitle: 'Click to crack the cookie and reveal your fortune.',
        nextIn: 'Next fortune in:',
        copy: 'Copy',
        copied: 'Copied!',
        share: 'Share',
        error: '“Something went wrong. Try again.”'
      },
      tr: {
        title: 'Falını görmek için kurabiyeye dokun',
        subtitle: 'Kurabiyeyi kır ve falını keşfet.',
        nextIn: 'Yeni fal için kalan süre:',
        copy: 'Kopyala',
        copied: 'Kopyalandı!',
        share: 'Paylaş',
        error: '“Bir şeyler ters gitti. Tekrar dene.”'
      }
    };

    function setLang(l){
      const dict = i18n[l] || i18n.en;
      document.documentElement.lang = l;
      titleEl.textContent = dict.title;
      subtitleEl.textContent = dict.subtitle;
      copyBtn.textContent = dict.copy;
      shareBtn.textContent = dict.share;
      langEN.classList.toggle('active', l==='en');
      langTR.classList.toggle('active', l==='tr');
      langEN.setAttribute('aria-pressed', l==='en');
      langTR.setAttribute('aria-pressed', l==='tr');
      localStorage.setItem('fc_lang', l);
      if (card.classList.contains('show')) refreshFortuneForLanguage();
    }

    const userLocale = (localStorage.getItem('fc_lang') || (navigator.language||'en').slice(0,2)).toLowerCase();
    setLang(userLocale === 'tr' ? 'tr' : 'en');
    langEN.addEventListener('click', () => setLang('en'));
    langTR.addEventListener('click', () => setLang('tr'));

    // ===== UI helpers =====
    function setFortune(text){
      fortuneText.textContent = '“' + text + '”';
      datePill.textContent = new Date().toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric'});
    }

    function confettiBurst(){
      confetti.style.display = 'block';
      confetti.style.opacity = '1';
      const dpr = window.devicePixelRatio || 1;
      const rect = confetti.getBoundingClientRect();
      const wCSS = rect.width || window.innerWidth;
      const hCSS = rect.height || window.innerHeight;
      const ctx = confetti.getContext('2d');
      confetti.width  = Math.floor(wCSS * dpr);
      confetti.height = Math.floor(hCSS * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      const w = wCSS, h = hCSS;
      const pieces = Array.from({length: 120}, () => ({
        x: Math.random()*w, y: -10, r: 4 + Math.random()*5,
        c: `hsl(${Math.floor(Math.random()*360)},85%,60%)`,
        vx: -1 + Math.random()*2, vy: 2 + Math.random()*3,
        a: Math.random()*Math.PI, va: 0.08 + Math.random()*0.06
      }));
      const DURATION = 1200;
      const start = performance.now();
      let rafId;
      function frame(t){
        const elapsed = t - start;
        ctx.clearRect(0,0,w,h);
        pieces.forEach(p=>{
          p.x += p.vx; p.y += p.vy; p.a += p.va; p.vy += 0.02;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
          ctx.fillStyle = p.c; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);
          ctx.restore();
        });
        if(elapsed < DURATION){ rafId = requestAnimationFrame(frame); }
        else {
          if(rafId) cancelAnimationFrame(rafId);
          ctx.clearRect(0,0,w,h);
          confetti.style.opacity = '0';
          setTimeout(() => { confetti.style.display = 'none'; }, 120);
        }
      }
      rafId = requestAnimationFrame(frame);
    }

    function formatHMS(totalSeconds){
      const h = String(Math.floor(totalSeconds/3600)).padStart(2,'0');
      const m = String(Math.floor((totalSeconds%3600)/60)).padStart(2,'0');
      const s = String(totalSeconds%60).padStart(2,'0');
      return `${h}:${m}:${s}`;
    }

    function secondsUntilLocalMidnight(){
      const now = new Date();
      const next = new Date(now); next.setHours(24,0,0,0);
      return Math.max(0, Math.floor((next - now)/1000));
    }

    // ===== Fortune fetching (AI -> classic -> mock) =====
    async function fetchFortune(){
      const lang = document.documentElement.lang === 'tr' ? 'tr' : 'en';
      const localDate = new Date().toISOString().slice(0,10);
      try{
        const resAI = await fetch('/api/fortune-ai', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lang, theme:'relationship', lines:2, localDate })
        });
        if(resAI.ok){
          const data = await resAI.json();
          console.log('[AI] response:', data);
          return { fortune: data.fortune, secondsUntilNext: secondsUntilLocalMidnight() };
        }
      }catch(e){ console.warn('[AI] fallback to classic:', e); }
      try{
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const res = await fetch(`/api/fortune?tz=${encodeURIComponent(tz)}`);
        if(!res.ok) throw new Error('Failed to fetch /api/fortune');
        const data = await res.json();
        console.log('[Classic] response:', data);
        return data;
      }catch(e){ console.warn('[Classic] fallback to mock:', e); }
      const list = (lang==='tr'
        ? ['Bugün atılan nazik bir mesaj yarını ısıtır.','Kalbini korurken kapıları tamamen kapatma.']
        : ['A gentle truth spoken today invites a tender reply.','Guard your heart, but don’t lock every door.']);
      const seed = new Date().toDateString() + '|' + lang;
      const idx = Math.abs([...seed].reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0)|0,0)) % list.length;
      const data = { fortune: list[idx], secondsUntilNext: secondsUntilLocalMidnight() };
      console.log('[Mock] response:', data);
      return data;
    }

    function startCountdown(seconds){
      let remain = Math.max(0, Math.floor(seconds));
      const tick = () => {
        countdownEl.textContent = formatHMS(remain);
        if(remain > 0) remain--; else clearInterval(timer);
      };
      tick();
      const timer = setInterval(tick, 1000);
    }

    async function refreshFortuneForLanguage(){
      try{
        const { fortune, secondsUntilNext } = await fetchFortune();
        setFortune(fortune);
        const dict = i18n[document.documentElement.lang] || i18n.en;
        note.textContent = dict.nextIn;
        if (!/\d\d:\d\d:\d\d/.test(countdownEl.textContent)) startCountdown(secondsUntilNext);
      }catch{
        const dict = i18n[document.documentElement.lang] || i18n.en;
        fortuneText.textContent = dict.error;
      }
    }

    // ===== Animation helpers & open flow =====
    function hideIntro(){
      if (titleEl)   titleEl.style.display = 'none';
      if (subtitleEl)subtitleEl.style.display = 'none';
      btn.classList.add('hide');
      setTimeout(()=>{ btn.style.display='none'; }, 200);
    }
    function onAnimationEndOnce(el){ return new Promise(r=>el.addEventListener('animationend', r, { once:true })); }
    function onAnimationStartOnce(el){ return new Promise(r=>el.addEventListener('animationstart', r, { once:true })); }

    async function openCookie(){
      if(btn.classList.contains('opened')) return;
      const left  = document.querySelector('.crack-left');
      const right = document.querySelector('.crack-right');
      const startP = (left ? onAnimationStartOnce(left) : Promise.resolve());
      const endP   = Promise.all([
        left  ? onAnimationEndOnce(left)  : Promise.resolve(),
        right ? onAnimationEndOnce(right) : Promise.resolve()
      ]);
      const safety = new Promise(res => setTimeout(res, 800));
      btn.classList.add('open','opened');
      await startP;
      confettiBurst();
      await Promise.race([ endP, safety ]);
      hideIntro();
      try{
        const { fortune, secondsUntilNext } = await fetchFortune();
        setFortune(fortune);
        card.classList.add('show');
        card.style.display = 'block';
        note.textContent = (i18n[document.documentElement.lang] || i18n.en).nextIn;
        startCountdown(secondsUntilNext);
        if(navigator.share){ shareBtn.hidden=false; }
      }catch{
        const dict = i18n[document.documentElement.lang] || i18n.en;
        card.classList.add('show');
        card.style.display = 'block';
        fortuneText.textContent = dict.error;
        note.textContent = '';
      }
    }

    // ===== Events =====
    btn.addEventListener('click', openCookie);
    window.addEventListener('keydown', (e)=>{ if(e.key===' '|| e.key==='Enter'){ e.preventDefault(); openCookie(); }});
    copyBtn.addEventListener('click', async ()=>{
      const text = fortuneText.textContent.replace(/^“|”$/g,'');
      try{
        await navigator.clipboard.writeText(text + ' — Fortune Cookie');
        const dict = i18n[document.documentElement.lang] || i18n.en;
        copyBtn.textContent = dict.copied;
        setTimeout(()=> copyBtn.textContent = dict.copy, 1200);
      }catch{ alert('Copied fortune: ' + text); }
    });
    shareBtn.addEventListener('click', async ()=>{
      const text = fortuneText.textContent.replace(/^“|”$/g,'');
      if(navigator.share){ try{ await navigator.share({ title:'My fortune', text }); }catch{} }
    });
  </script>
</body>
</html>
